<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Office Attendance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style> video { transform: scaleX(-1); } </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col items-center p-4 font-sans">

    <!-- Header -->
    <div class="w-full max-w-md flex justify-between items-center mb-6">
        <h1 class="text-xl font-bold tracking-tight">System<span class="text-blue-500">Active</span></h1>
        <div id="live-clock" class="text-xs bg-slate-800 px-2 py-1 rounded">00:00</div>
    </div>

    <!-- Camera Viewport -->
    <div class="relative w-full max-w-md aspect-[3/4] bg-black rounded-2xl overflow-hidden shadow-2xl border border-slate-700">
        <video id="video" class="w-full h-full object-cover" autoplay playsinline></video>
        <canvas id="canvas" class="hidden"></canvas>
        
        <!-- Action Area -->
        <div class="absolute bottom-0 w-full p-4 bg-gradient-to-t from-black via-black/80 to-transparent pt-10">
            <div id="message" class="text-center font-bold text-lg mb-3 min-h-[1.5rem] drop-shadow-md"></div>
            
            <!-- Scan Mode Buttons -->
            <div id="mode-scan" class="flex gap-2">
                <button onclick="capture('/scan')" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg transition active:scale-95">
                    SCAN FACE
                </button>
            </div>

            <!-- Register Mode Buttons -->
            <div id="mode-register" class="hidden flex flex-col gap-2">
                <input type="text" id="reg-name" placeholder="Full Name" class="w-full p-3 rounded-lg bg-slate-800 border border-slate-600 text-white text-center focus:border-blue-500 outline-none">
                <div class="flex gap-2">
                    <button onclick="switchMode('scan')" class="px-4 bg-slate-700 rounded-lg">Back</button>
                    <button onclick="capture('/register')" class="flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg">SAVE</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="mt-6 flex bg-slate-800 p-1 rounded-lg">
        <button onclick="switchMode('scan')" id="tab-scan" class="flex-1 py-2 rounded-md text-sm font-medium bg-slate-600 text-white shadow">Attendance</button>
        <button onclick="switchMode('register')" id="tab-reg" class="flex-1 py-2 rounded-md text-sm font-medium text-slate-400">Register</button>
    </div>

    <!-- Logs -->
    <div class="w-full max-w-md mt-6">
        <h3 class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Recent Scans</h3>
        <div id="logs" class="space-y-2 text-sm text-slate-300">Loading...</div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const msg = document.getElementById('message');

        // Start Camera
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
            .then(s => video.srcObject = s)
            .catch(e => msg.innerText = "Camera Access Denied");

        async function capture(endpoint) {
            msg.innerText = "Processing...";
            msg.className = "text-center font-bold text-lg mb-3 text-yellow-400";

            // Draw video frame to canvas
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const image = canvas.toDataURL('image/jpeg', 0.8);

            const payload = { image: image };
            if (endpoint === '/register') {
                const name = document.getElementById('reg-name').value;
                if (!name) return alert("Enter a name!");
                payload.name = name;
            }

            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    msg.innerText = endpoint === '/scan' ? `Welcome, ${data.name}!` : "Registered!";
                    msg.className = "text-center font-bold text-lg mb-3 text-green-400";
                    if(endpoint === '/register') {
                        document.getElementById('reg-name').value = '';
                        switchMode('scan');
                    }
                    loadLogs();
                } else {
                    msg.innerText = data.message;
                    msg.className = "text-center font-bold text-lg mb-3 text-red-500";
                }
            } catch (e) {
                msg.innerText = "Server Error";
            }
        }

        function switchMode(mode) {
            msg.innerText = "";
            document.getElementById('mode-scan').className = mode === 'scan' ? 'flex gap-2' : 'hidden';
            document.getElementById('mode-register').className = mode === 'register' ? 'hidden flex flex-col gap-2' : 'hidden'; // Correction: remove hidden if register
            
            if(mode === 'register') {
                 document.getElementById('mode-register').classList.remove('hidden');
                 document.getElementById('tab-reg').className = "flex-1 py-2 rounded-md text-sm font-medium bg-slate-600 text-white shadow";
                 document.getElementById('tab-scan').className = "flex-1 py-2 rounded-md text-sm font-medium text-slate-400";
            } else {
                 document.getElementById('mode-register').classList.add('hidden');
                 document.getElementById('tab-scan').className = "flex-1 py-2 rounded-md text-sm font-medium bg-slate-600 text-white shadow";
                 document.getElementById('tab-reg').className = "flex-1 py-2 rounded-md text-sm font-medium text-slate-400";
            }
        }

        async function loadLogs() {
            try {
                const res = await fetch('/logs');
                const data = await res.json();
                const container = document.getElementById('logs');
                container.innerHTML = data.map(l => `
                    <div class="bg-slate-800 p-3 rounded flex justify-between border-l-4 border-blue-500">
                        <span class="font-medium text-white">${l[0]}</span>
                        <span class="text-slate-400">${new Date(l[1]).toLocaleTimeString()}</span>
                    </div>
                `).join('');
            } catch(e) {}
        }
        
        setInterval(() => {
            document.getElementById('live-clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }, 1000);
        
        loadLogs();
    </script>
</body>
</html>